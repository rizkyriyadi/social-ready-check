rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is accessing their own document/resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user is a member of the circle (via subcollection existence)
    function isCircleMember(circleId) {
      return isAuthenticated() && exists(/databases/$(database)/documents/circles/$(circleId)/members/$(request.auth.uid));
    }

    // --- Users Collection ---
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);

      // Friends Subcollection (Reciprocal)
      match /friends/{friendId} {
        allow read: if isAuthenticated();
        // Owner can manage their list
        allow write: if isOwner(userId);
        // Allow the *other* user to add/remove THEMSELVES (reciprocal logic)
        allow create, delete: if isAuthenticated() && request.auth.uid == friendId;
      }
    }

    // --- Usernames ---
    match /usernames/{username} {
      allow read: if true;
      allow create: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.uid == request.auth.uid;
    }

    // --- Friend Requests ---
    match /friend_requests/{requestId} {
      // Allow read/write if user is sender or receiver
      allow read, write: if isAuthenticated() && 
        (resource.data.senderId == request.auth.uid || 
         resource.data.receiverId == request.auth.uid ||
         request.resource.data.senderId == request.auth.uid ||
         request.resource.data.receiverId == request.auth.uid);
    }

    // --- Circles (Squads) ---
    match /circles/{circleId} {
      // 1. Browsing/Listing: Allow auth users to read circles
      allow read: if isAuthenticated();
      
      // 2. Creation: Allow auth users to create circles
      allow create: if isAuthenticated();
      
      // 3. Updates: 
      // - Updating metadata/lastMessage (Members)
      // - Joining/Leaving (User adding/removing self from memberIds)
      allow update: if isAuthenticated(); 
      
      // 4. Deletion: Allow owner to delete (e.g. when last member leaves)
      allow delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      // Refined logic ideally checks if user is in 'memberIds' or adding self.
      
      // Members Subcollection
      match /members/{memberId} {
        allow read: if isAuthenticated();
        // User can write their own member document (Join/Leave)
        // OR the Circle Owner can manage members (e.g. promote new leader)
        allow write: if isOwner(memberId) || 
                     (exists(/databases/$(database)/documents/circles/$(circleId)) && 
                      get(/databases/$(database)/documents/circles/$(circleId)).data.ownerId == request.auth.uid);
      }

      // Messages Subcollection
      // Messages Subcollection
      match /messages/{messageId} {
        // Only members can read/send messages
        allow read: if isCircleMember(circleId);
        
        allow create: if isAuthenticated() && (
          // 1. Regular User Message: Must be member (or creating circle) AND sender matches auth
          ((isCircleMember(circleId) || !exists(/databases/$(database)/documents/circles/$(circleId)))
           && request.resource.data.senderId == request.auth.uid)
          ||
          // 2. System Message: Allow 'SYSTEM' sender (used during Join/Leave/Create)
          (request.resource.data.senderId == "SYSTEM" && request.resource.data.type == "SYSTEM")
        );
      }
    }
  }
}